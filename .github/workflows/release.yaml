---
name: Release PowerDNS Chart

on:
  push:
    branches:
    - main
    paths:
    - "powerdns/Chart.yaml"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    # https://github.com/actions/checkout
    - name: Checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "$GITHUB_ACTOR"
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

    # https://github.com/Azure/setup-helm
    - name: Set up Helm
      uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1
      with:
        version: "latest"

    - name: Log in to GitHub Container Registry
      run: |
        echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Package, Push Charts, and Tag Release
      run: |
        set -euo pipefail

        # Get repository owner in lowercase
        REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')

        # Track if any charts were released
        RELEASED=false
        SKIPPED=false

        for chart in $(find powerdns -name Chart.yaml -print | sed 's|/Chart.yaml||'); do
          if [ -d "$chart" ] && [ -f "$chart/Chart.yaml" ]; then
            chart_name=$(basename "$chart")
            chart_version=$(grep '^version:' "$chart/Chart.yaml" | awk '{print $2}')
            tag_name="${chart_name}-${chart_version}"

            echo "Processing $chart_name version $chart_version"

            # Check if this version already exists
            if helm pull "oci://ghcr.io/${REPO_OWNER}/${REPO_NAME}/${chart_name}" --version "${chart_version}" 2>/dev/null; then
              echo "‚è≠Ô∏è  Skipping ${chart_name}:${chart_version} - already exists in registry"
              rm -f "${chart_name}-${chart_version}.tgz"
              SKIPPED=true
              continue
            fi

            # Update dependencies
            helm dependency update "$chart"

            # Package the chart
            helm package "$chart"

            # Push to GHCR
            if helm push "${chart_name}-${chart_version}.tgz" "oci://ghcr.io/${REPO_OWNER}/${REPO_NAME}"; then
              echo "‚úÖ Successfully released $chart_name:$chart_version"
              RELEASED=true

              # Create tag if it doesn't exist locally or remotely
              if git ls-remote --tags origin "refs/tags/${tag_name}" | grep -q "${tag_name}$"; then
                echo "üè∑Ô∏è  Tag ${tag_name} already exists on origin, skipping"
              else
                git tag "${tag_name}"
                git push origin "${tag_name}"
                echo "üè∑Ô∏è  Pushed tag ${tag_name}"
              fi

            else
              echo "‚ùå Failed to release $chart_name:$chart_version"
              exit 1
            fi
          fi
        done

        if [ "$RELEASED" = false ] && [ "$SKIPPED" = true ]; then
          echo "‚ÑπÔ∏è  All chart versions already exist in registry. No new releases."
        fi

    - name: Logout from GHCR
      if: always()
      run: helm registry logout ghcr.io
